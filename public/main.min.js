const busIcon=document.getElementById("bus-icon");const busStop=document.getElementById("bus-stop");const busStopDistance=document.getElementById("bus-stop-distance");const busStopName=document.getElementById("bus-stop-name");const moon=document.querySelector("#moon-stars .moon");const moonStars=document.getElementById("moon-stars");const road=document.querySelector(".road");const sky=document.getElementById("sky");const starCanvas=document.getElementById("star-canvas");const statusText=document.getElementById("status-text");const sun=document.getElementById("sun");const timesText=document.getElementById("times-text");let currentStatus=null;let pollTimer=null;let roadBgPos=0;let roadMoving=true;let roadAnimId=null;const roadSpeed=1.2;const maxDistance=100;let stars=[];let twinkleAnimId=null;let countdownInterval=null;let lat=-27.491992;let lon=153.040728;let isNight=null;function startPolling(){if(pollTimer)return;pollTimer=setInterval(fetchStatus,3e4)}function stopPolling(){if(pollTimer){clearTimeout(pollTimer);pollTimer=null}}document.addEventListener("visibilitychange",()=>{if(document.hidden){stopPolling()}else{startPolling()}});function secondsToHHMMSS(seconds){const date=new Date(seconds*1e3);return date.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:true})}function animateRoad(){if(!roadMoving)return;roadBgPos-=roadSpeed;road.style.setProperty("--road-bg-x",`${roadBgPos}px`);roadAnimId=requestAnimationFrame(animateRoad)}function showBusStopAndStopRoad(data){setBusStopTransition(roadSpeed);busStop.classList.remove("visible");busStop.classList.remove("hidden");setTimeout(()=>{busStop.classList.add("visible")},20);busStop.addEventListener("transitionend",()=>{stopRoad(data)},{once:true})}function stopRoad(data){roadMoving=false;if(roadAnimId){cancelAnimationFrame(roadAnimId);if(data?.keyword){updateMessages(data.nearest.stopName||"Bus Status",currentStatus,"The bus has arrived!<br>Your keyword is: "+data.keyword,data.nearest)}roadAnimId=null}}function stopEverything(){stopPolling();stopRoad();if(countdownInterval){clearInterval(countdownInterval);countdownInterval=null}busIcon.classList.add("hidden");busStop.classList.add("hidden");setBusHeadlights(false)}function xorEncrypt(text,key){let result="";for(let i=0;i<text.length;i++){result+=String.fromCharCode(text.charCodeAt(i)^key.charCodeAt(i%key.length))}return btoa(result)}function updateMessages(busStop,status,message,nearest=null){busStopName.textContent=busStop;statusText.textContent=status.toUpperCase();timesText.innerHTML=message;if(busStopDistance&&nearest!==null){const{stopLat:stopLat,stopLon:stopLon}=nearest;getLiveDistance(stopLat,stopLon,distance=>{let distanceText=`Distance: <b>${displayDistance(distance)}</b>`;if(distance&&distance>maxDistance){distanceText+=`<br>\n\t\t\t\t<a href="https://www.google.com/maps/search/?api=1&query=${stopLat},${stopLon}" target="_blank">\n\t\t\t\t\tView in Google Maps\n\t\t\t\t</a>`}busStopDistance.innerHTML=distanceText})}}function displayDistance(distance){if(distance>=1e3){return(distance/1e3).toFixed(2)+"km"}else{return distance.toFixed(2)+"m"}}async function fetchStatus(){navigator.geolocation.getCurrentPosition(pos=>{const{latitude:latitude,longitude:longitude}=pos.coords;lat=latitude;lon=longitude;const loc=JSON.stringify({lat:lat,lon:lon});const encryptedLoc=xorEncrypt(loc,window.BUS_TOKEN);updateSkyBySunTimes(latitude,longitude);fetch("/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({loc:encryptedLoc})}).then(res=>{if(res.status===404){res.json().then(()=>{updateMessages("No Nearby Bus Stop","NO BUS STOP","Please go to a bus stop and try again.");stopEverything()});return null}else if(res.status===500){res.json().then(()=>{updateMessages("Server Error","ERROR",`\n\t\t\t\t\t\t\tError loading status<br>\n\t\t\t\t\t\t\tPlease try again later.\n\t\t\t\t\t\t\t`);stopEverything()});return null}return res.json()}).then(data=>{if(!data)return;if(!data.estimatedTime||!data.scheduledTime||data.status==="no_service"){updateMessages("Bus Status","NO SERVICE",`\n\t\t\t\t\t\t\t\tThe service is not currently running.<br>\n\t\t\t\t\t\t\t\t<a href="https://jp.translink.com.au/plan-your-journey/timetables/bus/t/61" target="_blank">\n\t\t\t\t\t\t\t\t\tView timetables on TransLink\n\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t`);stopEverything();return}busIcon.classList.remove("hidden");if(data.keyword){stopPolling()}startCountdown(data)}).catch(()=>{updateMessages("Bus Status","ERROR",`\n\t\t\t\t\t\tError loading status<br>\n\t\t\t\t\t\tPlease try again later.\n\t\t\t\t\t\t`);stopEverything()})},()=>{updateMessages("Could not get your location","NO LOCATION","Location access is required to find nearby bus stops.");stopEverything()})}function setBusStopTransition(roadSpeed){const vw=window.innerWidth;const style=getComputedStyle(document.documentElement);const rem=parseFloat(style.fontSize);const offsetPx=window.matchMedia("(max-width: 600px)").matches?1.2*rem:2*rem;const stopFinal=vw/2+offsetPx;const distance=vw-stopFinal;const frames=distance/roadSpeed;let duration=frames/60;duration*=.5;busStop.style.transition=`left ${duration}s linear`}function startCountdown(data){if(countdownInterval)clearInterval(countdownInterval);function updateCountdown(){const scheduled=secondsToHHMMSS(data.scheduledTime);currentStatus=data.status.replace("_"," ");const now=Math.floor(Date.now()/1e3);let diff=data.estimatedTime-now;if(diff<0)diff=0;const mins=Math.floor(diff/60);const secs=diff%60;let delayMsg="";const delayMins=Math.round(data.delay/60);if(data.status=="late"){delayMsg=`${delayMins} min ${currentStatus}`}else if(data.status=="early"){delayMsg=`${Math.abs(delayMins)} min ${currentStatus}`}else{delayMsg=currentStatus}updateMessages(data.nearest.stopName||"Bus Status",currentStatus,`\n\t\t\t\tThe bus scheduled to arrive at<br>\n\t\t\t\t<b>${scheduled}</b><br>\n\t\t\t\tis ${delayMsg} and will arrive in:<br>\n\t\t\t\t<b>${mins}m ${secs.toString().padStart(2,"0")}s</b>\n\t\t\t`,data.nearest);if(diff===0){clearInterval(countdownInterval);if(data.keyword){showBusStopAndStopRoad(data)}else if(data.nearest.distance!==null&&data.nearest.distance<=maxDistance){window.location.reload()}else{updateMessages(data.nearest.stopName||"Bus Status","NOT CLOSE ENOUGH",`\n                        The bus has arrived!<br>\n                        You need to get closer to the bus stop.\n                    `,data.nearest);showBusStopAndStopRoad(data);stopPolling()}}}updateCountdown();countdownInterval=setInterval(updateCountdown,1e3)}function updateSkyBySunTimes(lat,lon){const now=new Date;const times=SunCalc.getTimes(now,lat,lon);let bg;const nightNow=!(now>=times.dawn&&now<times.dusk);if(nightNow!==isNight){isNight=nightNow;if(isNight){if(starCanvas){starCanvas.style.display="";startStarAnimation()}}else{if(starCanvas)starCanvas.style.display="none";cancelStarAnimation()}}if(isNight){setBusHeadlights(true);if(sun)sun.style.display="none";if(moonStars)moonStars.style.display="";if(now>=times.dusk&&now<times.night||now>=times.nightEnd&&now<times.dawn){bg="linear-gradient(to bottom, #415a77 0%, #778da9 100%)";if(timesText)timesText.style.color="#cfe2ff";if(busStopDistance)busStopDistance.style.color="#cfe2ff"}else{bg="linear-gradient(to bottom, #232526 0%, #414345 100%)";if(timesText)timesText.style.color="#fffbe6";if(busStopDistance)busStopDistance.style.color="#fffbe6"}if(moon&&sky){const moonPos=SunCalc.getMoonPosition(now,lat,lon);const left=50+40*Math.sin(moonPos.azimuth);const top=90-140*(moonPos.altitude/(Math.PI/2));moon.style.left=`${left}%`;moon.style.top=`${top}%`}if(moon){const moonIllum=SunCalc.getMoonIllumination(now);moon.textContent=getMoonPhaseEmoji(moonIllum.phase)}}else{setBusHeadlights(false);bg="linear-gradient(to bottom, #87ceeb 0%, #f0f8ff 100%)";if(sun)sun.style.display="";if(moonStars)moonStars.style.display="none";if(timesText)timesText.style.color="#444";if(busStopDistance)busStopDistance.style.color="#444";if(sun&&sky){const sunPos=SunCalc.getPosition(now,lat,lon);const left=50+40*Math.sin(sunPos.azimuth);const top=90-140*(sunPos.altitude/(Math.PI/2));sun.style.left=`${left}%`;sun.style.top=`${top}%`}}document.body.style.background=bg}function getMoonPhaseEmoji(phase){if(phase<.03||phase>.97)return"ðŸŒ‘";if(phase<.22)return"ðŸŒ’";if(phase<.28)return"ðŸŒ“";if(phase<.47)return"ðŸŒ”";if(phase<.53)return"ðŸŒ•";if(phase<.72)return"ðŸŒ–";if(phase<.78)return"ðŸŒ—";return"ðŸŒ˜"}function setBusHeadlights(on){document.getElementById("headlight-beam").style.display=on?"block":"none"}updateSkyBySunTimes(lat,lon);setInterval(()=>{updateSkyBySunTimes(lat,lon)},60*1e3);roadMoving=true;animateRoad();startPolling();fetchStatus();busStop.classList.add("no-transition");setTimeout(()=>{busStop.classList.remove("no-transition")},100);function createStars(){const canvas=document.getElementById("star-canvas");if(!canvas)return;const dpr=window.devicePixelRatio||1;const width=window.innerWidth;const height=parseFloat(getComputedStyle(canvas).height);const starDensity=.6;const starCount=Math.round(width*starDensity);stars=[];for(let i=0;i<starCount;i++){stars.push({x:Math.random()*width*dpr,y:Math.random()*height*dpr,r:(Math.random()*.7+.3)*dpr,baseAlpha:Math.random()*.5+.5,twinkleSpeed:Math.random()*1.5+.5,twinklePhase:Math.random()*Math.PI*2})}}function animateStars(){const canvas=document.getElementById("star-canvas");if(!canvas)return;const dpr=window.devicePixelRatio||1;const width=window.innerWidth;const height=parseFloat(getComputedStyle(canvas).height);canvas.width=width*dpr;canvas.height=height*dpr;canvas.style.width=width+"px";canvas.style.height=height+"px";const ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);const now=performance.now()/1e3;for(const star of stars){const twinkle=.4*Math.sin(now*star.twinkleSpeed+star.twinklePhase);const alpha=Math.max(0,Math.min(1,star.baseAlpha+twinkle));ctx.globalAlpha=alpha;ctx.beginPath();ctx.arc(star.x,star.y,star.r,0,2*Math.PI);ctx.fillStyle="#fffbe6";ctx.shadowColor="#fffbe6";ctx.shadowBlur=4*dpr;ctx.fill()}ctx.globalAlpha=1;twinkleAnimId=requestAnimationFrame(animateStars)}function startStarAnimation(){cancelStarAnimation();createStars();animateStars()}function cancelStarAnimation(){if(twinkleAnimId){cancelAnimationFrame(twinkleAnimId);twinkleAnimId=null}}window.addEventListener("resize",startStarAnimation);function getLiveDistance(stopLat,stopLon,callback){let distance=null;navigator.geolocation.getCurrentPosition(pos=>{const{latitude:latitude,longitude:longitude}=pos.coords;distance=haversine(latitude,longitude,stopLat,stopLon);callback(distance)})}function haversine(lat1,lon1,lat2,lon2){function toRad(x){return x*Math.PI/180}const R=6371e3;const dLat=toRad(lat2-lat1);const dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c}